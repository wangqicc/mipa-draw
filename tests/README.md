# 测试用例文档

## 项目概述

mipa-draw 是一个基于 Vue3 + TypeScript + Pinia 的画板应用，支持贴纸拖拽、图层管理、历史记录等功能。

## 测试框架配置

### 安装的依赖

- **vitest**: 测试运行器
- **@vue/test-utils**: Vue组件测试工具
- **jsdom**: DOM环境模拟
- **@vitest/coverage-v8**: 代码覆盖率工具

### 测试命令

```bash
# 运行所有测试
npm test

# 运行测试并显示UI界面
npm run test:ui

# 运行测试并生成覆盖率报告
npm run test:coverage
```

## 当前测试覆盖率 (2025-12-28)

### 整体覆盖率统计
```
|---------|----------|---------|---------|
| % Stmts | % Branch | % Funcs | % Lines |
|---------|----------|---------|---------|
|   60.86 |     78.6 |   64.44 |   61.88 |
|---------|----------|---------|---------|
```

### 各文件覆盖率详情

| 文件 | 语句覆盖率 | 分支覆盖率 | 函数覆盖率 | 行覆盖率 | 主要未覆盖行 |
|------|------------|------------|------------|----------|--------------|
| App.vue | 72.54% | 87.5% | 75% | 77.08% | 72-87 |
| CanvasBoard.vue | 43.24% | 57.44% | 41.17% | 45.56% | 210-335,395-396 |
| ContextMenu.vue | 86.2% | 100% | 100% | 85.96% | 63,70,75-86 |
| LayerManager.vue | 73.91% | 81.81% | 100% | 72.72% | 16-36 |
| StickerPanel.vue | 100% | 100% | 100% | 100% | - |
| Toolbar.vue | 45.23% | 87.09% | 47.05% | 48.1% | 359,373-384,396 |
| canvas.ts (store) | 65.07% | 50% | 68.42% | 63.44% | 498,513,521-549 |

## 测试用例结构

### 1. 类型定义测试 (`tests/types/index.test.ts`)

验证项目中定义的所有TypeScript接口：

- **Sticker接口**: 验证贴纸对象的属性类型和约束
- **CanvasSettings接口**: 验证画布设置对象的属性
- **HistoryState接口**: 验证历史记录状态结构
- **BackgroundOption接口**: 验证背景选项结构
- **类型约束**: 验证枚举类型的有效性

✅ **覆盖率: 100%** - 已完整覆盖所有类型定义

### 2. Store测试 (`tests/stores/canvas.test.ts`)

测试Pinia store的核心功能：

#### 初始状态测试
- 验证画布默认设置（尺寸、背景色、网格等）
- 验证初始状态（空贴纸数组、选择状态等）

#### 贴纸管理测试
- 添加贴纸功能
- 删除贴纸功能
- 更新贴纸属性
- 复制贴纸功能
- 批量删除选中贴纸
- 批量复制选中贴纸

#### 选择管理测试
- 单个贴纸选择
- 清除选择
- 切换选择状态
- 添加到选择
- 批量选择管理

#### 图层管理测试
- 置顶功能
- 置底功能
- 上移一层
- 下移一层
- 批量图层操作

#### 历史记录测试
- 保存历史记录
- 撤销操作
- 重做操作
- 历史记录数量限制

#### 画布设置测试
- 缩放功能
- 缩放范围限制
- 清空画布

#### 计算属性测试
- 最大z-index计算
- 空状态处理

⚠️ **覆盖率: 65.07%** - 需要提升，特别是历史记录和优化功能

### 3. 组件测试

#### CanvasBoard组件 (`tests/components/CanvasBoard.test.ts`)
- 组件渲染测试
- 网格线显示
- 背景样式应用
- 贴纸渲染
- 坐标计算
- 鼠标事件处理
- 选择框显示
- 响应式更新
- 拖拽状态管理
- 窗口大小变化处理
- 事件监听器清理

⚠️ **覆盖率: 43.24%** - 主要待提升区域，需要增加交互和边界测试

#### Toolbar组件 (`tests/components/Toolbar.test.ts`)
- 工具栏渲染
- 工具按钮显示
- 工具选择处理
- 当前选中工具显示
- 响应式更新

⚠️ **覆盖率: 45.23%** - 需要增加工具切换和交互测试

#### PropertiesPanel组件 (`tests/components/PropertiesPanel.test.ts`)
- 属性面板渲染
- 属性控件显示
- 属性变更处理
- 选中元素属性显示
- 响应式更新

❌ **覆盖率: 0%** - 缺少测试文件，需要创建

#### LayerManager组件 (`tests/components/LayerManager.test.ts`)
- 图层管理器渲染
- 图层列表显示
- 图层操作处理
- 图层顺序显示
- 响应式更新

✅ **覆盖率: 73.91%** - 良好，但可进一步提升

#### StickerPanel组件 (`tests/components/StickerPanel.test.ts`)
- 贴纸面板渲染
- 贴纸选项显示
- 贴纸选择处理
- 贴纸预览
- 文件上传测试
- 拖拽事件处理
- 错误边界测试
- 响应式更新

✅ **覆盖率: 100%** - 已完整覆盖

#### ContextMenu组件 (`tests/components/ContextMenu.test.ts`)
- 上下文菜单渲染
- 菜单选项显示
- 菜单选择处理
- 位置显示
- 响应式更新

✅ **覆盖率: 86.2%** - 良好，少量边界情况待覆盖

### 4. 应用集成测试 (`tests/App.test.ts`)
- 主应用渲染
- 主要组件包含
- Pinia store设置
- 响应式更新
- 键盘快捷键处理
- 拖拽事件处理
- 上下文菜单集成

✅ **覆盖率: 72.54%** - 良好，主要功能已覆盖

## 覆盖率提升计划

### 🎯 目标覆盖率 (2025-12-31前)
- **语句覆盖率**: >80% (当前60.86%)
- **分支覆盖率**: >80% (当前78.6%)
- **函数覆盖率**: >85% (当前64.44%)
- **行覆盖率**: >80% (当前61.88%)

### 📋 优先级任务

#### 🔥 高优先级 (立即执行)
1. **创建PropertiesPanel组件测试** - 新增测试文件
2. **增强CanvasBoard组件测试** - 增加鼠标交互、边界处理
3. **增强Toolbar组件测试** - 增加工具切换、状态管理

#### ⚡ 中优先级 (本周完成)
1. **增强canvas store测试** - 历史记录、优化功能
2. **增强App.vue测试** - 错误处理、边界情况
3. **完善ContextMenu测试** - 边界条件、异常处理

#### 📈 低优先级 (持续改进)
1. **优化现有测试** - 减少重复，提高效率
2. **增加性能测试** - 大数据量处理
3. **增加集成测试** - 端到端场景

### 🛠️ 具体改进措施

#### 1. CanvasBoard组件提升 (目标: 80%+)
```typescript
// 需要增加的测试场景
- 鼠标拖拽完整流程测试
- 多选贴纸操作测试
- 旋转手柄交互测试
- 缩放手柄边界测试
- 画布缩放功能测试
- 网格对齐功能测试
- 选择框复杂场景测试
- 键盘事件处理测试
```

#### 2. Toolbar组件提升 (目标: 80%+)
```typescript
// 需要增加的测试场景
- 工具切换状态管理
- 工具按钮交互效果
- 工具快捷键处理
- 工具状态持久化
- 响应式布局测试
```

#### 3. PropertiesPanel组件 (目标: 90%+)
```typescript
// 需要创建完整测试文件
- 属性面板显示/隐藏
- 属性值绑定和更新
- 属性变更事件处理
- 不同类型属性控件
- 属性验证和错误处理
```

#### 4. Canvas Store提升 (目标: 85%+)
```typescript
// 需要增加的测试场景
- 历史记录优化功能
- 批量操作性能测试
- 内存管理测试
- 错误恢复机制
- 数据持久化测试
```

## 测试最佳实践

1. **单元测试**: 每个函数和组件独立测试
2. **集成测试**: 测试组件间的交互
3. **边界测试**: 测试异常输入和边界条件
4. **响应式测试**: 验证Vue的响应式系统
5. **类型测试**: 验证TypeScript类型定义
6. **性能测试**: 验证大数据量处理能力
7. **错误处理**: 验证异常情况和错误恢复

## 运行测试结果

✅ **当前状态** (2025-12-28):
- 测试用例: 197个
- 通过率: 100%
- TypeScript错误: 0个
- 主要覆盖: 核心功能、组件渲染、基础交互

⚠️ **待改进区域**:
- CanvasBoard: 复杂交互场景
- Toolbar: 工具状态管理
- PropertiesPanel: 缺失测试文件
- Canvas Store: 高级功能

所有测试用例都遵循了Vue3和TypeScript的最佳实践，确保代码质量和可维护性。覆盖率提升工作正在进行中，预计在2025年12月31日前达到目标覆盖率。