<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多贴纸旋转撤销测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-area {
            border: 2px dashed #ccc;
            height: 400px;
            position: relative;
            margin: 20px 0;
            background: #fafafa;
        }
        .sticker {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #3b82f6;
            border: 2px solid #1e40af;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: move;
            transition: outline 0.2s;
        }
        .sticker.selected {
            outline: 3px solid #10b981;
            outline-offset: 2px;
        }
        .sticker.multi-selected {
            outline: 2px dashed #60a5fa;
            outline-offset: 1px;
        }
        .rotate-handle {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            cursor: grab;
            display: none;
        }
        .sticker.selected .rotate-handle {
            display: block;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .info {
            background: #e0f2fe;
            border: 1px solid #0288d1;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .history-info {
            background: #f3e5f5;
            border: 1px solid #7b1fa2;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>多贴纸旋转撤销功能测试</h1>
        
        <div class="info">
            <strong>测试说明：</strong>
            <ul>
                <li>点击贴纸进行选择（支持多选：按住Ctrl或Shift点击）</li>
                <li>拖拽绿色旋转手柄来旋转选中的贴纸</li>
                <li>使用撤销/重做按钮测试历史记录功能</li>
                <li>观察旋转操作是否按预期分组</li>
            </ul>
        </div>

        <div class="controls">
            <button id="addSticker">添加贴纸</button>
            <button id="clearAll">清空所有</button>
            <button id="undo" disabled>撤销 (Ctrl+Z)</button>
            <button id="redo" disabled>重做 (Ctrl+Y)</button>
            <button id="selectAll">全选</button>
            <button id="deselectAll">取消选择</button>
        </div>

        <div class="history-info" id="historyInfo">
            历史记录: 0/0 | 操作: 无
        </div>

        <div class="test-area" id="testArea">
            <!-- 贴纸将在这里动态创建 -->
        </div>

        <div class="info">
            <strong>快捷键：</strong>
            <ul>
                <li>Ctrl+Z: 撤销</li>
                <li>Ctrl+Y: 重做</li>
                <li>Ctrl+A: 全选</li>
                <li>Delete: 删除选中</li>
            </ul>
        </div>
    </div>

    <script>
        class StickerSystem {
            constructor() {
                this.stickers = [];
                this.selectedIds = [];
                this.history = [];
                this.historyIndex = -1;
                this.stickerCounter = 0;
                this.isRotating = false;
                this.rotationStart = 0;
                this.stickerStartStates = new Map();
                
                this.init();
            }

            init() {
                this.testArea = document.getElementById('testArea');
                this.historyInfo = document.getElementById('historyInfo');
                
                document.getElementById('addSticker').addEventListener('click', () => this.addSticker());
                document.getElementById('clearAll').addEventListener('click', () => this.clearAll());
                document.getElementById('undo').addEventListener('click', () => this.undo());
                document.getElementById('redo').addEventListener('click', () => this.redo());
                document.getElementById('selectAll').addEventListener('click', () => this.selectAll());
                document.getElementById('deselectAll').addEventListener('click', () => this.deselectAll());
                
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                
                // 添加初始贴纸
                this.addSticker(100, 100);
                this.addSticker(200, 100);
                this.addSticker(300, 100);
                
                this.updateHistoryInfo();
            }

            addSticker(x = Math.random() * 300 + 50, y = Math.random() * 200 + 50) {
                const id = `sticker-${this.stickerCounter++}`;
                const sticker = {
                    id,
                    x,
                    y,
                    width: 80,
                    height: 80,
                    rotation: 0,
                    name: `贴纸${this.stickerCounter}`
                };
                
                this.stickers.push(sticker);
                this.createStickerElement(sticker);
                this.saveHistory('add_sticker');
            }

            createStickerElement(sticker) {
                const element = document.createElement('div');
                element.className = 'sticker';
                element.id = sticker.id;
                element.style.left = sticker.x + 'px';
                element.style.top = sticker.y + 'px';
                element.style.width = sticker.width + 'px';
                element.style.height = sticker.height + 'px';
                element.style.transform = `rotate(${sticker.rotation}deg)`;
                element.textContent = sticker.name;
                
                // 添加旋转手柄
                const rotateHandle = document.createElement('div');
                rotateHandle.className = 'rotate-handle';
                element.appendChild(rotateHandle);
                
                // 事件监听
                element.addEventListener('click', (e) => this.handleStickerClick(e, sticker.id));
                rotateHandle.addEventListener('mousedown', (e) => this.startRotation(e, sticker.id));
                
                this.testArea.appendChild(element);
            }

            handleStickerClick(e, stickerId) {
                if (e.target.classList.contains('rotate-handle')) return;
                
                if (e.ctrlKey || e.shiftKey) {
                    this.toggleSelection(stickerId);
                } else {
                    this.selectOnly(stickerId);
                }
            }

            selectOnly(stickerId) {
                this.selectedIds = [stickerId];
                this.updateSelectionDisplay();
            }

            toggleSelection(stickerId) {
                const index = this.selectedIds.indexOf(stickerId);
                if (index === -1) {
                    this.selectedIds.push(stickerId);
                } else {
                    this.selectedIds.splice(index, 1);
                }
                this.updateSelectionDisplay();
            }

            selectAll() {
                this.selectedIds = this.stickers.map(s => s.id);
                this.updateSelectionDisplay();
            }

            deselectAll() {
                this.selectedIds = [];
                this.updateSelectionDisplay();
            }

            updateSelectionDisplay() {
                this.stickers.forEach(sticker => {
                    const element = document.getElementById(sticker.id);
                    if (element) {
                        element.classList.remove('selected', 'multi-selected');
                        if (this.selectedIds.includes(sticker.id)) {
                            if (this.selectedIds.length === 1) {
                                element.classList.add('selected');
                            } else {
                                element.classList.add('multi-selected');
                            }
                        }
                    }
                });
            }

            startRotation(e, stickerId) {
                e.stopPropagation();
                
                if (!this.selectedIds.includes(stickerId)) {
                    this.selectOnly(stickerId);
                }
                
                this.isRotating = true;
                
                // 计算选中贴纸的中心点
                let totalX = 0, totalY = 0, count = 0;
                this.selectedIds.forEach(id => {
                    const sticker = this.stickers.find(s => s.id === id);
                    if (sticker) {
                        totalX += sticker.x + sticker.width / 2;
                        totalY += sticker.y + sticker.height / 2;
                        count++;
                    }
                });
                
                if (count > 0) {
                    const centerX = totalX / count;
                    const centerY = totalY / count;
                    
                    const rect = this.testArea.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const angle = Math.atan2(mouseY - centerY, mouseX - centerX);
                    this.rotationStart = angle * (180 / Math.PI);
                    
                    // 保存所有选中贴纸的初始状态
                    this.stickerStartStates.clear();
                    this.selectedIds.forEach(id => {
                        const sticker = this.stickers.find(s => s.id === id);
                        if (sticker) {
                            this.stickerStartStates.set(id, {
                                x: sticker.x,
                                y: sticker.y,
                                width: sticker.width,
                                height: sticker.height,
                                rotation: sticker.rotation
                            });
                        }
                    });
                    
                    document.addEventListener('mousemove', this.handleRotation.bind(this));
                    document.addEventListener('mouseup', this.endRotation.bind(this));
                }
            }

            handleRotation(e) {
                if (!this.isRotating) return;
                
                const rect = this.testArea.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // 计算选中贴纸的中心点
                let totalX = 0, totalY = 0, count = 0;
                this.selectedIds.forEach(id => {
                    const startState = this.stickerStartStates.get(id);
                    if (startState) {
                        totalX += startState.x + startState.width / 2;
                        totalY += startState.y + startState.height / 2;
                        count++;
                    }
                });
                
                if (count > 0) {
                    const centerX = totalX / count;
                    const centerY = totalY / count;
                    
                    const angle = Math.atan2(mouseY - centerY, mouseX - centerX);
                    const newRotation = angle * (180 / Math.PI) - this.rotationStart;
                    
                    // 量化旋转角度（每5度一个步长）
                    const quantizedRotation = Math.round(newRotation / 5) * 5;
                    
                    // 批量旋转所有选中的贴纸
                    this.selectedIds.forEach(id => {
                        const sticker = this.stickers.find(s => s.id === id);
                        const startState = this.stickerStartStates.get(id);
                        if (sticker && startState) {
                            sticker.rotation = startState.rotation + quantizedRotation;
                            
                            const element = document.getElementById(id);
                            if (element) {
                                element.style.transform = `rotate(${sticker.rotation}deg)`;
                            }
                        }
                    });
                }
            }

            endRotation(e) {
                if (this.isRotating) {
                    this.isRotating = false;
                    this.saveHistory('rotate_stickers');
                    
                    document.removeEventListener('mousemove', this.handleRotation.bind(this));
                    document.removeEventListener('mouseup', this.endRotation.bind(this));
                }
            }

            saveHistory(operation) {
                // 保存当前状态
                const state = {
                    stickers: this.stickers.map(s => ({...s})),
                    selectedIds: [...this.selectedIds],
                    operation: operation,
                    timestamp: Date.now()
                };
                
                // 截断历史记录（移除当前索引之后的内容）
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                // 添加新状态
                this.history.push(state);
                this.historyIndex = this.history.length - 1;
                
                // 限制历史记录数量
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
                
                this.updateHistoryInfo();
                this.updateUndoRedoButtons();
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    const state = this.history[this.historyIndex];
                    this.restoreState(state);
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    const state = this.history[this.historyIndex];
                    this.restoreState(state);
                }
            }

            restoreState(state) {
                // 清除现有贴纸
                this.testArea.innerHTML = '';
                this.stickers = [];
                
                // 恢复贴纸
                state.stickers.forEach(sticker => {
                    this.stickers.push({...sticker});
                    this.createStickerElement(sticker);
                });
                
                // 恢复选择状态
                this.selectedIds = [...state.selectedIds];
                this.updateSelectionDisplay();
                
                this.updateHistoryInfo();
                this.updateUndoRedoButtons();
            }

            updateHistoryInfo() {
                const current = this.history[this.historyIndex];
                const operation = current ? current.operation : '无';
                this.historyInfo.textContent = `历史记录: ${this.historyIndex + 1}/${this.history.length} | 操作: ${operation}`;
            }

            updateUndoRedoButtons() {
                document.getElementById('undo').disabled = this.historyIndex <= 0;
                document.getElementById('redo').disabled = this.historyIndex >= this.history.length - 1;
            }

            clearAll() {
                this.testArea.innerHTML = '';
                this.stickers = [];
                this.selectedIds = [];
                this.history = [];
                this.historyIndex = -1;
                this.stickerCounter = 0;
                this.updateHistoryInfo();
                this.updateUndoRedoButtons();
            }

            handleKeyDown(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 'z':
                            e.preventDefault();
                            if (e.shiftKey) {
                                this.redo();
                            } else {
                                this.undo();
                            }
                            break;
                        case 'y':
                            e.preventDefault();
                            this.redo();
                            break;
                        case 'a':
                            e.preventDefault();
                            this.selectAll();
                            break;
                    }
                } else if (e.key === 'Delete') {
                    this.deleteSelected();
                }
            }

            deleteSelected() {
                if (this.selectedIds.length > 0) {
                    this.stickers = this.stickers.filter(s => !this.selectedIds.includes(s.id));
                    this.selectedIds = [];
                    
                    // 重新渲染
                    this.testArea.innerHTML = '';
                    this.stickers.forEach(sticker => this.createStickerElement(sticker));
                    
                    this.saveHistory('delete_selected');
                }
            }
        }

        // 初始化系统
        const system = new StickerSystem();
        
        // 添加一些使用说明
        console.log('多贴纸旋转撤销测试系统已启动');
        console.log('测试步骤：');
        console.log('1. 选择多个贴纸（按住Ctrl点击）');
        console.log('2. 拖拽绿色旋转手柄旋转贴纸');
        console.log('3. 使用Ctrl+Z撤销，观察是否按预期工作');
        console.log('4. 使用Ctrl+Y重做，观察是否按预期工作');
    </script>
</body>
</html>